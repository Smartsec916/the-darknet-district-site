<!DOCTYPE html>
<html lang="en">
<head>
  <base href="/blackout-protocol/">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Byte Bazaar — Add-Men</title>
  <script>
(function bootstrapSession(){
  try {
    if (!sessionStorage.getItem('bp_session_started')) {
      try { sessionStorage.clear(); } catch(e){}
      sessionStorage.setItem('bp_session_started', '1');
    }
    // Manual tester override: add ?fresh=1 to URL to force-clear mid-session
    var _qs = new URLSearchParams(location.search);
    if (_qs.has('fresh')) {
      try { sessionStorage.clear(); } catch(e){}
      sessionStorage.setItem('bp_session_started', '1');
    }
  } catch(e){/* noop */}
})();
</script>
  <style>
    :root{
      --frame-w:960px;
      --ink:#e6ffd5; --ink-dim:#b7d8b0; --edge:#284235;
      --crt-green:#b7ff44; --crt-fill-1:#112414; --crt-fill-2:#0b1a0e; --accent:#8ad0ff;
    }
    html,body{margin:0;height:100%;background:#050b14;color:var(--ink);font-family:ui-monospace,Menlo,Consolas,monospace;overflow:hidden}
    .frame{position:relative;width:100%;max-width:var(--frame-w);margin:0 auto;aspect-ratio:4/3;border:2px solid #1a2830;border-radius:14px;background:#000;box-shadow:0 18px 80px rgba(0,0,0,.45) inset, 0 16px 60px rgba(16,28,48,.35)}
    .keeper{position:absolute; inset:0;object-fit:cover;width:100%;height:100%;image-rendering:pixelated}

    .crt{
      position:absolute;padding:14px 16px;border-radius:18px;color:var(--ink);
      border:2px solid color-mix(in oklab, var(--crt-green) 55%, #1a3b18);
      background:linear-gradient(180deg, color-mix(in oklab, var(--crt-fill-1) 96%, #000), color-mix(in oklab, var(--crt-fill-2) 98%, #000));
      box-shadow:0 0 0 2px rgba(183,255,68,.06) inset, 0 18px 26px rgba(0,0,0,.45) inset, 0 0 18px rgba(183,255,68,.08);
      text-shadow:0 0 2px rgba(183,255,68,.3), 0 0 8px rgba(183,255,68,.12);
      overflow:hidden;
    }
    .crt::before{
      content:"";position:absolute; inset:0;pointer-events:none;
      background:
        repeating-linear-gradient(0deg, rgba(183,255,68,.12) 0 1px, transparent 1px 3px),
        repeating-linear-gradient(90deg, rgba(183,255,68,.055) 0 1px, transparent 1px 5px);
      mix-blend-mode:screen;opacity:.32;
    }

    .badge{position:absolute;left:3%;top:4%;padding:6px 9px;border-radius:12px;background:rgba(7,14,10,.78);border:1px solid var(--edge)}
    .badge .lbl{color:var(--accent)}

    .bubble{right:4%;top:8%;max-width:36%}
    .bubble h3{margin:0 0 6px 0;color:#99ff6a;font-size:12px;letter-spacing:.5px}
    .bubble .text{white-space:pre-wrap;line-height:1.4em;min-height:2.6em}
    .bubble .cursor{display:inline-block;width:7px;height:1em;background:#7cff57;margin-left:2px;animation:blink .9s steps(1) infinite;vertical-align:-2px}
    @keyframes blink{50%{opacity:0}}

    .inv{left:3%;top:18%;width:22%;min-height:120px}
    .inv h4{margin:0 0 8px 0;color:#a7ff89;font-size:12px;letter-spacing:.5px}
    .slot{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px;border-radius:12px;margin:6px 0;border:1px dashed rgba(183,255,68,.35);background:rgba(10,22,12,.35);color:var(--ink)}
    .tag{font-size:10px;color:#c1ffae}

    .items{position:absolute;left:3%;right:22%;bottom:4%;display:flex;gap:12px;flex-wrap:wrap}
    .card{position:relative;flex:0 1 260px}
    .card h5{margin:0 0 6px 0;font-size:13px;letter-spacing:.3px;color:#cfff9f}
    .card p{margin:0 0 10px 0;color:var(--ink-dim);font-size:12px}
    .price{color:#9cff7e}
    .buy{cursor:pointer;border-radius:10px;border:1px solid #2f3c56;background:#0f1522;color:#d9f7ff;padding:8px 10px}
    .buy[disabled]{opacity:.5;cursor:not-allowed}

    .continue{position:absolute;right:3%;bottom:4%}
    .continue .card{cursor:pointer;user-select:none}
    .continue .card:hover{box-shadow:0 0 0 2px rgba(183,255,68,.14)}
  </style>
</head>
<body>
  <div class="frame">
    <img id="keeper" class="keeper" src="assets/shop_addmen.png" alt="Add-Men">

    <div class="badge">Balance → <span class="lbl" id="balLbl">BTC:0</span></div>

    <div class="crt bubble">
      <h3>【Add-Men】</h3>
      <div class="text" id="bubble"></div>
    </div>

    <div class="crt inv">
      <h4>Inventory</h4>
      <div class="slot" id="emptySlot"><span>Nothing installed yet.</span></div>
      <div class="list" id="invList"></div>
    </div>

    <div class="items" id="items"></div>

    <div class="continue">
      <div class="crt card" id="continueCard">
        <h5>Continue</h5>
        <p>Head back out. Unspent BTC carries forward.</p>
      </div>
    </div>
  </div>

<script>
// Storage helpers for session-scoped saves
const getN=(k,d=0)=>{const n=parseInt(sessionStorage.getItem(k)||'');return Number.isFinite(n)?n:d;}
const setN=(k,v)=>sessionStorage.setItem(k,String(v));
const getO=(k)=>{try{return JSON.parse(sessionStorage.getItem(k)||'{}')}catch{ return {} }};
const setO=(k,v)=>sessionStorage.setItem(k,JSON.stringify(v));

const HYPER_RELOAD_TAG = 'rev=' + Date.now();
document.getElementById('keeper').src = 'assets/shop_addmen.png?' + HYPER_RELOAD_TAG;

const items=[
  {id:1,name:'Double Jump',price:50,desc:'Unlock double jump ability',effect:'doubleJump'},
  {id:2,name:'Body Armor',price:75,desc:'Reduce damage by 50%',effect:'armor'},
  {id:3,name:'Medkits x3',price:30,desc:'Heal to full health 3 times',effect:'medkits'},
  {id:4,name:'EMP Grenades x5',price:100,desc:'5 EMP grenades to disable enemies',effect:'emp'}
];

// Pull from URL if present; otherwise from sessionStorage
let BTC   = (v=>{const n=parseInt(v||'');return Number.isFinite(n)?n:getN('playerBTC',0)})(new URLSearchParams(location.search).get('btc'));
let SCORE = (v=>{const n=parseInt(v||'');return Number.isFinite(n)?n:getN('playerScore',0)})(new URLSearchParams(location.search).get('score'));
let LVL   = (v=>{const n=parseInt(v||'');return Number.isFinite(n)?n:getN('gameLevel',1)})(new URLSearchParams(location.search).get('level'));
let UPG   = getO('playerUpgrades');
let inventory = getO('playerInventory');

// SAFETY: if this page is opened with no run state, kick back to a clean game start
const runMissing = !sessionStorage.getItem('playerBTC') && !sessionStorage.getItem('playerScore') && Object.keys(UPG).length===0 && Object.keys(inventory).length===0;
if (runMissing && BTC === 0 && SCORE === 0){
  try { sessionStorage.clear(); } catch {}
  sessionStorage.setItem('bp_session_started', '1');
  location.href = 'index.html';
}

let balance = BTC;

function updateBalance(){ balLbl.textContent = 'BTC:'+balance; }
function showOwned(name, tag){
  emptySlot.style.display='none';
  const row=document.createElement('div'); row.className='slot';
  row.innerHTML = `<span><strong>${name}</strong></span><span class="tag">${tag||''}</span>`;
  invList.appendChild(row);
}

/* typewriter */
async function typeLine(text, speed=28){
  return new Promise(resolve=>{
    let i=0; bubbleEl.innerHTML='';
    const cursor=document.createElement('span'); cursor.className='cursor';
    const step=()=>{ 
      if(i<text.length){
        bubbleEl.textContent = text.slice(0, ++i);
        bubbleEl.appendChild(cursor);
        setTimeout(step, speed);
      }else{
        bubbleEl.textContent = text; resolve();
      }
    };
    bubbleEl.onclick = ()=>{ i=text.length; };
    step();
  });
}

function has(id){ return !!UPG[id]; }

/* Inventory per level (what’s for sale *in this shop*) */
function catalogForLevel(level){
  if(level <= 1){
    return [
      {id:'mobileEMP', label:'Mobile EMP', desc:'+2 charges. Trigger EMP anywhere. (E)', cost:5,
       grant:()=>{UPG.mobileEMP=true; UPG.mobileEMPCharges=(UPG.mobileEMPCharges||0)+2; showOwned('Mobile EMP', 'Charges: '+(UPG.mobileEMPCharges|0));}}
    ];
  }
  if(level === 2){
    return [
      {id:'mobileEMP', label:'Mobile EMP (+2)', desc:'+2 charges. Trigger EMP anywhere. (E)', cost:5,
       grant:()=>{UPG.mobileEMP=true; UPG.mobileEMPCharges=(UPG.mobileEMPCharges||0)+2; showOwned('Mobile EMP', 'Charges: '+(UPG.mobileEMPCharges|0));}},
      {id:'coinMagnet', label:'BTC Magnet', desc:'Pulls nearby BTC toward you.', cost:10,
       grant:()=>{UPG.coinMagnet=true; showOwned('BTC Magnet');}}
    ];
  }
  // Shop 3 (arms locker)
  return [
    {id:'mobileEMP', label:'Mobile EMP (+2)', desc:'+2 charges. Trigger EMP anywhere. (E)', cost:5,
     grant:()=>{UPG.mobileEMP=true; UPG.mobileEMPCharges=(UPG.mobileEMPCharges||0)+2; showOwned('Mobile EMP', 'Charges: '+(UPG.mobileEMPCharges|0));}},
    {id:'coinMagnet', label:'BTC Magnet', desc:'Pulls nearby BTC toward you.', cost:10,
     grant:()=>{UPG.coinMagnet=true; showOwned('BTC Magnet');}},
    {id:'sidearm', label:'Sidearm / Gun', desc:'Placeholder weapon for later levels.', cost:15,
     grant:()=>{UPG.sidearm=true; showOwned('Sidearm');}}
  ];
}
let CATALOG = [];

/* render items (EMP repeatable; others one-time) */
function renderItems(){
  itemsWrap.innerHTML='';
  CATALOG.forEach(item=>{
    const already = item.id!=='mobileEMP' && has(item.id);
    const card=document.createElement('div'); card.className='crt card';
    card.innerHTML=`
      <h5>${item.label}</h5>
      <p>${item.desc}</p>
      <button class="buy"${(balance<item.cost||already)?' disabled':''}>Buy — <span class="price">${item.cost} BTC</span></button>`;
    const btn = card.querySelector('.buy');
    btn.onclick=()=>{
      if(balance < item.cost || (item.id!=='mobileEMP' && has(item.id))) return;
      balance -= item.cost;
      item.grant(); save();
      renderItems();
      updateBalance();
    };
    itemsWrap.appendChild(card);
  });
}

// SAVE back to session
function save(){
  setO('playerUpgrades',UPG);
  setO('playerInventory',inventory);
  setN('playerBTC', balance);
  setN('playerScore', SCORE);
  setN('gameLevel', LVL);
}

// Resume the game (health will be forced to 100 in index.html startLevel)
function resumeGame(){
  save();
  const url = `index.html?resume=1&level=${LVL}&score=${SCORE}&btc=${balance}`;
  location.href = url;
}

function continueGame(){
  resumeGame();
}

(async function init(){
  updateBalance();

  /* Reflect existing inventory — EMP only if charges > 0 */
  if(UPG.mobileEMP && (UPG.mobileEMPCharges|0) > 0){
    showOwned('Mobile EMP', 'Charges: '+(UPG.mobileEMPCharges|0));
  }
  if(UPG.coinMagnet){ showOwned('BTC Magnet'); }
  if(UPG.sidearm){ showOwned('Sidearm'); }

  const linesByLevel = {
    1: "Greetings, Netrunner. I'm Add-Men.\nWelcome to my shop.\n\nMy inventory is pretty limited at the moment.",
    2: "Welcome back. New stock just hit the shelf:\nA BTC Magnet. Pulls coins in while you dance with the drones.",
    3: "You're in luck. Arms locker just opened.\nIf you can afford it: a sidearm."
  };
  await typeLine(linesByLevel[LVL] || linesByLevel[1]);

  CATALOG = catalogForLevel(LVL);
  renderItems();
})();
</script>
</body>
</html>